---
title: "Assignment 3"
author: "Marco Palombo"
date: "4/19/2022"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(thematic)
library(scales)
library(equatiomatic)
```

```{r}
# Read in the main data set
data <- read_csv(here("HW3_data.csv")) %>% 
  clean_names()
```

### 1. 

Assuming that one kWh of electricity emits 0.85 pounds of CO2 and that the interim SCC of $51/ton is accurate, this section calculates the MEC per kWh.

```{r}
# Create a longer dataset where income is a variable, not a column 
data_long <- data %>% 
  pivot_longer(cols = c(q_low_kwh, q_high_kwh),
               names_to = 'income_level',
               values_to = 'kwh') %>% 
  mutate(income_level = case_when(income_level == 'q_low_kwh' ~ 'low',
                   income_level == 'q_high_kwh' ~ 'high'))
# Run a simple calculation to get the MEC 
interim_price_ton <- 51
#2205 lbs in a metric ton. Divide by 0.85 to get kwh produced per ton
kwh_ton <- 2204.6/0.85
# Multiply by Biden price to get MEC/kWh (Basically, $51 is the price for 2594 kwh)
interim_price_kwh <- 51/kwh_ton
```

Use dimensional analysis for solution:
$\mathrm{\frac{1~kWh}{.85~lb~CO_2}*\frac{2204.6~lb~CO_2}{1~tonne~CO_2}*\frac{1~tonne}{\$51}}$ = $`r round(interim_price_kwh, 4)`.

### 2
What is the aggregate monthly demand curve for electricity? What is the supply curve for
electricity? What is the “benefit” to consumers under the status quo? What is the “benefit”
to producers under the status quo? What is the environmental cost under the status quo?
Low income demand curve:

```{r}
# Calculate aggregate demand curve for electricity
# First get lm estimates from data for both low and high
demand_low <- lm(price_cents ~ kwh, income_level=='low', 
                 data = data_long) 
extract_eq(model = demand_low, use_coefs = TRUE, coef_digits = 5)
```

High income demand curve:
```{r}
demand_high <- lm(price_cents ~ kwh, income_level=='high',
                  data = data_long) 
extract_eq(model = demand_high, use_coefs = TRUE, coef_digits = 5)

# Generalized demand model from sample code 
demand <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}

# Generalized aggregate demand, pulled from code sample
demand_agg <- function(p){
  q <- demand(p, demand_low) + demand(p, demand_high)
  return(q)
}

```

Perform a horizontal sum to get an aggregate demand curve. This does not follow a perfect line due to the kink at the top. 

```{r}
# take care of kink, pulled from code sample
price = seq(0, 30, length.out = 100)
Qagg <- map(price, demand_agg) %>% 
  unlist()
agg_df<- tibble(Qagg = Qagg, price = price)

```

Use given price of 0.10 cents/kWh and 0 intercept to create function for supply. Plug in 0.10 cents/kWh to get quantity. Use this point and the zero intercept to create function for the line passing through these points.

```{r}
quantity <- demand_agg(10)
#536,719.5 kWh consumed @ $0.10
supply_slope <- 10/quantity
supply <- function(p){
  q <- p/supply_slope
  return(q)
}
```
Supply curve:
P(cents) =`r supply_slope`(cents/kWh*Q

```{r}
# CS needs Y intercept --> at 0 kWh, price would be $0.305
# Note the conversion back to dollars 
cs_baseline <- 0.5*quantity*(0.305 - 0.10)
# $55,013.74
# PS easy, just go up to 10 and out to the kwh 
ps_baseline <- 0.5*quantity*0.10
# $26,835.97
# cost is rectangle 
env_cost_baseline <- interim_price_kwh*quantity
# $10,553.75
```

- Consumer Benefit is area under aggregated demand curve above equilibrium price of 10 cents:
$`r round(cs_baseline, 0)`
- Producer Benefit is area under price of 10 cents and above supply curve:
$`r round(ps_baseline, 0)`
- Environmental Cost is product of equilibrium price and total energy sold at this price:
$`r round(env_cost_baseline, 0)`

#### Figure of curves
```{r}
# create figure of curves
ggplot(agg_df, aes(Qagg, price)) +
  geom_line(color = "blue") +
  annotate("text", x = 400000, y = 17, 
           label = "Aggregate Demand", angle = -30) +
  geom_abline(color = "red",
              intercept = demand_high$coefficients[1],
              slope= demand_high$coefficients[2]) +
  annotate("text", x = 300000, y = 15, 
           label = "High Income Demand", angle = -40) +
  geom_abline(color = "green",
              intercept = demand_low$coefficients[1],
              slope= demand_low$coefficients[2]) +
  annotate("text", x = 150000, y = 10, 
           label = "Low Income Demand", angle = -58) +
  geom_abline(color = "orange",
              intercept = 0,
              slope= supply_slope) +
  annotate("text", x = 300000, y = 7, 
           label = "Supply", angle = 17) +
  labs(x = "Energy (kWh)",
       y = "Price (cents/kWh)")
  
```


### 3
 How is the current consumer benefit divided between “high” and “low” income consumers?
 
 Determine quantity each group will purchase at this price, then calculate areas. 

```{r}
# low income demand
#demand(10, demand_low)
# Low income gets 121,344 
#0 intercept is 23.37
cs_low <- 0.5*(.2337 - .10)*demand(10, demand_low)
# Note: this is negative (-$2441) if we apply full env. cost 

#0 intercept is 31.61
cs_high <- 0.5*(.3161-.10)*demand(10, demand_high)
# $44,881.3 CS for high income assuming no EC 
```

High income consumers have much much higher benefit than low income consumers. 
- Low-income: $`r round(cs_low, 0)`
- High-income: $`r round(cs_high, 0)`

### 4

Derive the optimal electricity tax (in cents per kWh) using the interim SCC. Noting that recent
research has shown the poor face a disproportionate share of the impacts from climate change,
assume that the climate externality is borne entirely by the “low” income group.

I will apply the tax to the demand functions. I will subtract the entirety of the externality from low income consumers in their overall welfare calculation.

```{r}
# Apply tax to both consumers 
tax_cents <- 1.97
# shift demand curves down by 1.97 cents
demand_tax <- function(p, model){
  q <- (p - (model$coefficients[[1]]-1.97))/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
} 

#new aggregated demand function
demand_agg_tax <- function(p){
  q <- demand_tax(p, demand_low) + demand_tax(p, demand_high)
  return(q)
}

#use uniroot to find intercept of supply and taxed aggregated demand functions
p_new <- round(uniroot(function(p) demand_agg_tax(p) - supply(p), interval = c(0,20))$root,2)
 #determine demanded quantity at this price
q_new <- demand_agg_tax(p_new)

#change in demand
demand_change <- demand_agg(10) - demand_agg_tax(p_new)

#change in cost
price_change <- 10 - p_new

# high income welfare
##NOTE: here is where my assumptions will start. I will not apply any of the environmental externality to high income consumers.
demand_high_tax <- demand_tax(p_new, demand_high)
welfare_high_tax <- (0.5 * (.3161 - 0.0197 - 0.0932) * demand_high_tax) - (demand_high_tax * 0.0197)

# change in high income welfare
welfare_high_change <- cs_high - welfare_high_tax

# low income welfare, apply assumption of environmental cost falling entirely on this group for pre tax case 
welfare_low_baseline <- cs_low - env_cost_baseline

#calculate environmental cost at this tax value
env_cost_tax <- interim_price_kwh * q_new

# solve for post tax demand
demand_low_tax <- demand(p_new, demand_low)
# use value to solve for welfare. AGAIN This is where my assumption is applied. I'm taking the entire environmental cost and subtracting it from low income consumers
welfare_low_tax <- (0.5 * (.2337 - 0.0197 - 0.0932) * demand_low_tax) - (demand_low_tax * 0.0197) - env_cost_tax

#calculate change in welfare for low income people
welfare_low_change <- welfare_low_baseline - welfare_low_tax

#E. Producer surplus
ps_tax <- 0.5*q_new*0.0932
#change
ps_change <- ps_baseline - ps_tax

#F. ENV damage change
damage_change <- env_cost_baseline - env_cost_tax

#G. Tax revenue 
tax_revenue <- interim_price_kwh*q_new
```


A: Electricity consumed decreases by `r round(demand_change, 0)`kWh. Total consumption is `r round(q_new, 0)` with this tax.

B: The price of electricity decreases by $`r round(price_change, 2)`. The new price is \$`r p_new`/kWh with this tax.

C: The welfare of high-income decreases by $`r round(welfare_high_change, 0)`. This includes the cost of taxes paid by these consumers.

D: The welfare of low-income consumers decreases by $`r round(welfare_low_change, 0)`. 

Note: welfare was already negative for low-income consumers if we assume they bear the full environmental cost associated with electricity production.*

E: The producer surplus decreases by $ `r round(ps_change, 0)`.

F: The environmental damage decreases by $`r round(damage_change, 0)`.

G: Tax revenue generated is $`r round(tax_revenue, 0)`. This is equal to the total environmental cost.

### 5. Redistribution

```{r}
#wow_this_question_is_repetitive_dear_god_there_must_be_a_better_way <- function(SCC){
  #calculate price of kwh considering given SCC, this will end up being the tax
SCC <- 51  
tax <- SCC/2204.6*.85
  
  #define demand functions
  # shift demand curves down by price of kwh
demand_tax <- function(p, model){
  q <- (p - (model$coefficients[[1]]-tax*100))/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
}

#aggregate demand function
demand_agg_tax <- function(p){
  q <- demand_tax(p, demand_low) + demand_tax(p, demand_high)
  return(q)
}

#use uniroot to find intercept of supply and taxed aggregated demand functions
price <- round(uniroot(function(p) demand_agg_tax(p) - supply(p), interval = c(0,20))$root,2)

#total quantity purchased
total <- demand_agg_tax(price)

#damage and tax revenue are the same so just calculate it once
damage_tax_revenue <- total*price/100

#now determine proportion consumed by the two income levels
#high income
high_consumption_frac <- demand(price,demand_high)/total
#low income
low_consumption_frac <- demand(price,demand_low)/total

#using this we can now calculate welfare
#first get redistribution
high_redist <- damage_tax_revenue*high_consumption_frac
low_redist <- damage_tax_revenue*low_consumption_frac

#high
high_welfare <- 0.5*(demand(0,demand_high)-demand(price,demand_high)) + high_redist

#low
low_welfare_area <- 0.5*(demand(0,demand_low)-demand(price,demand_low))

low_welfar <- low_welfare_area - damage_tax_revenue + low_redist

#producer surplus
producer_surp <- 0.5*price*demand_agg(price)

#populate list of things to output
outputs <- list("high_welfare" = high_welfare, "low_welfar" = low_welfare, "producer_surplus" = producer_surp)

#return(outputs)

#}
```

```{r}
test <- wow_this_question_is_repetitive_dear_god_there_must_be_a_better_way(1.97)

# Calculating different prices 
# If price/ton is $75 --- 75/(2204.6/0.85) --- $0.0289/kWh
# If price/ton is $100 --- 100/(2204.6/0.85)--- $0.0386.kWh
# If price/ton is $125 --- 125/(2204.6/0.85) --- $0.0482/kWh
# If price/ton is $150 --- 150/(2204.6/0.85) --- $0.0578/kWh
price_c_75 <- 2.89
price_c_100 <- 3.86
price_c_125 <- 4.82
price_c_150 <- 5.78
# pre-tax consumption 
low_share <- demand(10, demand_low)/quantity
#22.61%
high_share <- demand(10, demand_high)/quantity
#77.39%
# @ $51 (the original SCC):
low_redist_51 <- low_share*tax_revenue
#Get $2224 back
low_welfare_51 <- low_redist_51 + welfare_low_tax
#New welfare is equal to initial welfare --- (-$2422)
high_redist_51 <- high_share*tax_revenue
# Get $7612 back 
high_welfare_51 <- high_redist_51 + welfare_high_tax
```

At $51 SCC with redistribution based on pre-tax consumption share: 

**A:** High-income welfare *increases* by $`r round(high_redist_51, 0)`.

**B:** Low-income welfare *increases* by $`r round(low_redist_51, 0)`. *Note: low-income welfare is still negative.*

**C:** Producer welfare is unchanged ($`r round(ps_tax, 0)`).

```{r}
###### Welfare @ $75
```


```{r}
###### Welfare @ $100
```


```{r}
###### Welfare @ $125
```


### **6. Solar PV**